name: Deploy Gmail Client to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Verify SSH connection
      run: |
        ssh -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'echo "SSH OK"'
      # Fails here? Check: VPS_SSH_PRIVATE_KEY, VPS_SERVER_IP, VPS_SSH_USER in repo Secrets

    - name: Setup VPS Environment
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'SETUP_EOF'
          set -e
          echo "=== Setting up VPS Environment for Gmail Client ==="
          SUDO=""
          if [ "$(id -u)" -ne 0 ] && command -v sudo &> /dev/null; then SUDO="sudo"; fi

          # Node.js telepítése (ha nincs)
          if ! command -v node &> /dev/null; then
            echo "Installing Node.js 20..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | $SUDO bash -
            $SUDO apt-get install -y nodejs
            echo "Node.js installed: $(node -v)"
          else
            echo "Node.js already installed: $(node -v)"
          fi

          # Nginx telepítése (ha nincs)
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            $SUDO apt-get update
            $SUDO apt-get install -y nginx
            $SUDO systemctl start nginx
            $SUDO systemctl enable nginx
            echo "Nginx installed"
          else
            echo "Nginx already installed"
          fi

          # Git telepítése (ha nincs)
          if ! command -v git &> /dev/null; then
            echo "Installing Git..."
            $SUDO apt-get install -y git
            echo "Git installed"
          else
            echo "Git already installed"
          fi

          # Projekt könyvtár létrehozása (jogosultság deploy usernek ha nem root)
          $SUDO mkdir -p /var/www/gmail-client
          if [ -n "$SUDO" ]; then
            $SUDO chown -R "$(whoami):$(id -gn)" /var/www/gmail-client
          fi
          echo "=== VPS Environment Ready ==="
        SETUP_EOF

    - name: Deploy Backend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          set -e
          cd /var/www/gmail-client

          # Fix git ownership issue
          git config --global --add safe.directory /var/www/gmail-client

          if [ ! -d ".git" ]; then
            echo "Cloning repository..."
            cd /var/www
            rm -rf gmail-client
            git clone https://github.com/${{ github.repository }}.git gmail-client
            cd gmail-client
          else
            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          fi

          echo "Installing backend dependencies (including dev for build)..."
          cd server
          npm ci

          echo "Backend deployment completed!"
        EOF

    - name: Create Backend Environment File
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} "bash -s" << EOF
          echo "Creating .env file for backend..."
          cat > /var/www/gmail-client/server/.env << 'ENVFILE'
        PORT=5000
        SESSION_SECRET=${{ secrets.SESSION_SECRET }}
        ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REDIRECT_URI=https://mail.mindenes.org/api/auth/callback
        FRONTEND_URL=https://mail.mindenes.org
        NODE_ENV=production
        ENVFILE
          echo "Backend .env created"
        EOF

    - name: Create Backend Service
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} "bash -s" << 'EOF'
          echo "Creating systemd service..."
          tee /etc/systemd/system/gmail-client-backend.service > /dev/null << 'SERVICEFILE'
        [Unit]
        Description=Gmail Client Backend Service
        After=network.target

        [Service]
        Type=simple
        User=www-data
        WorkingDirectory=/var/www/gmail-client/server
        EnvironmentFile=/var/www/gmail-client/server/.env
        ExecStart=/usr/bin/node dist/server.js
        Restart=always
        RestartSec=10

        # Logging
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=gmail-client-backend

        [Install]
        WantedBy=multi-user.target
        SERVICEFILE

          systemctl daemon-reload
          systemctl enable gmail-client-backend
          echo "Backend service created"
        EOF

    - name: Build Backend TypeScript
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          set -e
          cd /var/www/gmail-client/server

          # Clean dist folder to ensure fresh build
          echo "Cleaning dist folder..."
          rm -rf dist

          echo "Building TypeScript..."
          npm run build

          # Verify key files exist
          echo "Verifying build..."
          ls -la dist/server.js
          ls -la dist/routes/labels.routes.js
          ls -la dist/routes/push.routes.js

          echo "Backend TypeScript compiled successfully"
        EOF

    - name: Setup Node.js for Frontend Build
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build Frontend
      run: |
        cd client
        npm ci --legacy-peer-deps
        # Production API URL beállítása
        echo "VITE_API_URL=https://mail.mindenes.org/api" > .env.production
        npm run build
        echo "Frontend build completed!"

    - name: Deploy Frontend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'mkdir -p /var/www/gmail-client/client/dist'
        scp -r client/dist/* ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }}:/var/www/gmail-client/client/dist/
        echo "Frontend files copied!"

    - name: Configure Nginx
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          tee /etc/nginx/sites-available/gmail-client > /dev/null << 'NGINXCONF'
        # Rate limiting
        limit_req_zone $binary_remote_addr zone=gmail_api_limit:10m rate=10r/s;

        # Upstream backend
        upstream gmail_backend {
            server localhost:5000;
            keepalive 32;
        }

        server {
            listen 80;
            server_name mail.mindenes.org;

            # Redirect to HTTPS
            return 301 https://$server_name$request_uri;
        }

        server {
            listen 443 ssl http2;
            server_name mail.mindenes.org;

            # SSL will be configured by certbot
            ssl_certificate /etc/letsencrypt/live/mail.mindenes.org/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/mail.mindenes.org/privkey.pem;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers HIGH:!aNULL:!MD5;
            ssl_prefer_server_ciphers on;

            # Logging
            access_log /var/log/nginx/gmail-client-access.log;
            error_log /var/log/nginx/gmail-client-error.log;

            # Max upload size (mellékletek)
            client_max_body_size 25M;

            # Frontend (React build)
            location / {
                root /var/www/gmail-client/client/dist;
                index index.html;
                try_files $uri $uri/ /index.html;

                # Cache static assets
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # Security headers
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
            }

            # Backend API
            location /api {
                limit_req zone=gmail_api_limit burst=20 nodelay;

                proxy_pass http://gmail_backend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;

                # Timeouts
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # Health check
            location /health {
                access_log off;
                proxy_pass http://gmail_backend/api/health;
            }
        }
        NGINXCONF

          # Enable site
          ln -sf /etc/nginx/sites-available/gmail-client /etc/nginx/sites-enabled/

          # Test nginx config
          nginx -t && systemctl reload nginx
          echo "Nginx configured and reloaded!"
        EOF

    - name: Start Backend Service
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          set -e
          
          # Create logs directory for winston logger
          echo "Creating logs directory..."
          mkdir -p /var/www/gmail-client/server/logs
          
          # Create data directory for SQLite database
          echo "Creating data directory..."
          mkdir -p /var/www/gmail-client/server/data
          
          # Verify dist/server.js exists before proceeding
          echo "Verifying server files..."
          if [ ! -f /var/www/gmail-client/server/dist/server.js ]; then
            echo "ERROR: dist/server.js not found!"
            ls -la /var/www/gmail-client/server/
            ls -la /var/www/gmail-client/server/dist/ 2>/dev/null || echo "dist folder not found"
            exit 1
          fi
          echo "dist/server.js found: $(ls -la /var/www/gmail-client/server/dist/server.js)"
          
          # Jogosultságok beállítása
          echo "Setting permissions..."
          chown -R www-data:www-data /var/www/gmail-client
          chmod -R 755 /var/www/gmail-client/server/dist

          # Reset systemd failure counter and stop service
          echo "Stopping old backend..."
          systemctl reset-failed gmail-client-backend 2>/dev/null || true
          systemctl stop gmail-client-backend || true
          pkill -f "node dist/server.js" || true
          sleep 2

          # Clear old journal logs to avoid confusion
          journalctl --rotate 2>/dev/null || true
          journalctl --vacuum-time=1s 2>/dev/null || true

          # Backend indítása
          echo "Starting backend..."
          systemctl start gmail-client-backend

          # Várakozás
          sleep 5

          # Ellenőrzés hogy fut-e
          if ! systemctl is-active --quiet gmail-client-backend; then
            echo "Service failed to start! Checking logs..."
            journalctl -u gmail-client-backend --no-pager -n 50 --since "1 minute ago"
            
            echo ""
            echo "=== Testing manual startup as www-data ==="
            cd /var/www/gmail-client/server
            echo "Current directory: $(pwd)"
            echo "Node version: $(node -v)"
            echo "Files in dist:"
            ls -la dist/ | head -10
            echo ""
            echo "Testing node directly (will show actual error):"
            cd /var/www/gmail-client/server
            echo "Environment check:"
            cat .env | grep -v SECRET | grep -v KEY || echo "No .env"
            echo ""
            echo "Checking node_modules:"
            ls -la node_modules 2>&1 | head -5 || echo "No node_modules!"
            echo ""
            echo "Running node as root first (to see error without permission issues):"
            cd /var/www/gmail-client/server
            set -a && source .env && set +a
            node dist/server.js 2>&1 &
            NPID=$!
            sleep 3
            if ps -p $NPID > /dev/null; then
              echo "Server is running! Killing..."
              kill $NPID
            else
              echo "Server crashed! Exit code: $(wait $NPID; echo $?)"
            fi
            exit 1
          fi

          # Check for startup errors in logs
          echo "Recent backend logs:"
          journalctl -u gmail-client-backend --no-pager -n 20 --since "1 minute ago"

          echo "Backend service started and verified"
        EOF

    - name: Setup SSL Certificate
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          # Certbot telepítése ha nincs
          if ! command -v certbot &> /dev/null; then
            apt-get install -y certbot python3-certbot-nginx
          fi

          # SSL tanúsítvány kérése (ha még nincs)
          if [ ! -f "/etc/letsencrypt/live/mail.mindenes.org/fullchain.pem" ]; then
            certbot --nginx -d mail.mindenes.org --non-interactive --agree-tos --email admin@mindenes.org --redirect || echo "SSL setup may need manual intervention"
          else
            echo "SSL certificate already exists"
          fi
        EOF

    - name: Verify Deployment
      run: |
        echo "Waiting for services to start..."
        sleep 10
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          set -e
          echo "=== Gmail Client Deployment Status ==="
          echo ""
          echo "Backend service:"
          systemctl status gmail-client-backend --no-pager | head -10
          echo ""
          echo "Nginx service:"
          systemctl status nginx --no-pager | head -5
          echo ""
          echo "Testing endpoints:"
          curl -sf -o /dev/null http://localhost:5000/api/health && echo "✓ Health endpoint OK"

          # Check labels endpoint (should return 400, not 404)
          echo "Testing labels endpoint..."
          LABELS_RESPONSE=$(curl -s http://localhost:5000/api/labels)
          LABELS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/labels)
          echo "Labels response: $LABELS_RESPONSE"
          echo "Labels status: $LABELS_STATUS"

          if [ "$LABELS_STATUS" = "400" ]; then
            echo "✓ Labels endpoint OK (returns 400 without auth)"
          elif [ "$LABELS_STATUS" = "404" ]; then
            echo "✗ Labels endpoint returned 404 - route not registered!"
            echo ""
            echo "Checking dist files..."
            ls -la /var/www/gmail-client/server/dist/routes/ | head -20
            echo ""
            echo "Checking server.js imports..."
            head -30 /var/www/gmail-client/server/dist/server.js
            echo ""
            echo "Checking package.json type..."
            cat /var/www/gmail-client/server/package.json | head -10
            exit 1
          else
            echo "Labels endpoint returned unexpected status: $LABELS_STATUS"
            exit 1
          fi
          echo ""
          echo "=== Deployment Complete ==="
          echo "Gmail Client available at: https://mail.mindenes.org"
        EOF
