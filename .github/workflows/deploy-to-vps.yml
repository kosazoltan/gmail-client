name: Deploy Gmail Client to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Setup VPS Environment
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'SETUP_EOF'
          set -e
          echo "=== Setting up VPS Environment for Gmail Client ==="

          # Node.js telepítése (ha nincs)
          if ! command -v node &> /dev/null; then
            echo "Installing Node.js 20..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs
            echo "Node.js installed: $(node -v)"
          else
            echo "Node.js already installed: $(node -v)"
          fi

          # Nginx telepítése (ha nincs)
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            apt-get update
            apt-get install -y nginx
            systemctl start nginx
            systemctl enable nginx
            echo "Nginx installed"
          else
            echo "Nginx already installed"
          fi

          # Git telepítése (ha nincs)
          if ! command -v git &> /dev/null; then
            echo "Installing Git..."
            apt-get install -y git
            echo "Git installed"
          else
            echo "Git already installed"
          fi

          # Projekt könyvtár létrehozása
          mkdir -p /var/www/gmail-client
          echo "=== VPS Environment Ready ==="
        SETUP_EOF

    - name: Deploy Backend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          cd /var/www/gmail-client

          if [ ! -d ".git" ]; then
            echo "Cloning repository..."
            cd /var/www
            rm -rf gmail-client
            git clone https://github.com/${{ github.repository }}.git gmail-client
            cd gmail-client
          else
            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          fi

          echo "Installing backend dependencies..."
          cd server
          npm ci --production

          echo "Backend deployment completed!"
        EOF

    - name: Create Backend Environment File
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} "bash -s" << EOF
          echo "Creating .env file for backend..."
          cat > /var/www/gmail-client/server/.env << 'ENVFILE'
        PORT=5000
        SESSION_SECRET=${{ secrets.SESSION_SECRET }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        GOOGLE_REDIRECT_URI=https://mail.mindenes.org/api/auth/google/callback
        FRONTEND_URL=https://mail.mindenes.org
        NODE_ENV=production
        ENVFILE
          echo "Backend .env created"
        EOF

    - name: Create Backend Service
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} "bash -s" << 'EOF'
          echo "Creating systemd service..."
          tee /etc/systemd/system/gmail-client-backend.service > /dev/null << 'SERVICEFILE'
        [Unit]
        Description=Gmail Client Backend Service
        After=network.target

        [Service]
        Type=simple
        User=www-data
        WorkingDirectory=/var/www/gmail-client/server
        EnvironmentFile=/var/www/gmail-client/server/.env
        ExecStart=/usr/bin/node dist/server.js
        Restart=always
        RestartSec=10

        # Logging
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=gmail-client-backend

        [Install]
        WantedBy=multi-user.target
        SERVICEFILE

          systemctl daemon-reload
          systemctl enable gmail-client-backend
          echo "Backend service created"
        EOF

    - name: Build Backend TypeScript
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          cd /var/www/gmail-client/server
          npm run build || npx tsc
          echo "Backend TypeScript compiled"
        EOF

    - name: Setup Node.js for Frontend Build
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build Frontend
      run: |
        cd client
        npm ci
        # Production API URL beállítása
        echo "VITE_API_URL=https://mail.mindenes.org/api" > .env.production
        npm run build
        echo "Frontend build completed!"

    - name: Deploy Frontend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'mkdir -p /var/www/gmail-client/client/dist'
        scp -r client/dist/* ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }}:/var/www/gmail-client/client/dist/
        echo "Frontend files copied!"

    - name: Configure Nginx
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          tee /etc/nginx/sites-available/gmail-client > /dev/null << 'NGINXCONF'
        # Rate limiting
        limit_req_zone $binary_remote_addr zone=gmail_api_limit:10m rate=10r/s;

        # Upstream backend
        upstream gmail_backend {
            server localhost:5000;
            keepalive 32;
        }

        server {
            listen 80;
            server_name mail.mindenes.org;

            # Redirect to HTTPS
            return 301 https://$server_name$request_uri;
        }

        server {
            listen 443 ssl http2;
            server_name mail.mindenes.org;

            # SSL will be configured by certbot
            ssl_certificate /etc/letsencrypt/live/mail.mindenes.org/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/mail.mindenes.org/privkey.pem;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers HIGH:!aNULL:!MD5;
            ssl_prefer_server_ciphers on;

            # Logging
            access_log /var/log/nginx/gmail-client-access.log;
            error_log /var/log/nginx/gmail-client-error.log;

            # Max upload size (mellékletek)
            client_max_body_size 25M;

            # Frontend (React build)
            location / {
                root /var/www/gmail-client/client/dist;
                index index.html;
                try_files $uri $uri/ /index.html;

                # Cache static assets
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # Security headers
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
            }

            # Backend API
            location /api {
                limit_req zone=gmail_api_limit burst=20 nodelay;

                proxy_pass http://gmail_backend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;

                # Timeouts
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # Health check
            location /health {
                access_log off;
                proxy_pass http://gmail_backend/health;
            }
        }
        NGINXCONF

          # Enable site
          ln -sf /etc/nginx/sites-available/gmail-client /etc/nginx/sites-enabled/

          # Test nginx config
          nginx -t && systemctl reload nginx
          echo "Nginx configured and reloaded!"
        EOF

    - name: Start Backend Service
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          # Jogosultságok beállítása
          chown -R www-data:www-data /var/www/gmail-client

          # Backend újraindítása
          systemctl restart gmail-client-backend || systemctl start gmail-client-backend

          echo "Backend service started"
        EOF

    - name: Setup SSL Certificate
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          # Certbot telepítése ha nincs
          if ! command -v certbot &> /dev/null; then
            apt-get install -y certbot python3-certbot-nginx
          fi

          # SSL tanúsítvány kérése (ha még nincs)
          if [ ! -f "/etc/letsencrypt/live/mail.mindenes.org/fullchain.pem" ]; then
            certbot --nginx -d mail.mindenes.org --non-interactive --agree-tos --email admin@mindenes.org --redirect || echo "SSL setup may need manual intervention"
          else
            echo "SSL certificate already exists"
          fi
        EOF

    - name: Verify Deployment
      run: |
        echo "Waiting for services to start..."
        sleep 10
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          echo "=== Gmail Client Deployment Status ==="
          echo ""
          echo "Backend service:"
          systemctl status gmail-client-backend --no-pager | head -10
          echo ""
          echo "Nginx service:"
          systemctl status nginx --no-pager | head -5
          echo ""
          echo "Testing local connection:"
          curl -s -o /dev/null -w "Backend HTTP Status: %{http_code}\n" http://localhost:5000/health || echo "Backend not responding yet"
          echo ""
          echo "=== Deployment Complete ==="
          echo "Gmail Client available at: https://mail.mindenes.org"
        EOF
